# Vasooly Testing Guide

**Date**: 2025-10-17
**Status**: Complete ✅

---

## Overview

Complete testing infrastructure for Vasooly including unit tests, E2E tests, code coverage, and CI/CD pipeline.

---

## 1. Unit Testing (Jest)

### Configuration

**File**: `jest.config.js`

**Features**:
- Jest preset: `jest-expo`
- Test environment: Node
- Coverage collection from `src/**/*.{ts,tsx}`
- Coverage thresholds: 70% minimum
- Module path aliasing: `@/` → `src/`
- Transform ignore patterns for React Native modules

### Commands

```bash
# Run all tests
npm test

# Watch mode for development
npm run test:watch

# Generate coverage report
npm run test:coverage

# CI mode (for pipelines)
npm run test:ci
```

### Coverage Reports

**Outputs**:
- Text summary (console)
- HTML report (coverage/lcov-report/index.html)
- LCOV format (coverage/lcov.info) for Codecov

**Thresholds**:
- Branches: 70%
- Functions: 70%
- Lines: 70%
- Statements: 70%

### Existing Tests

✅ **Split Engine** (10 tests, 100% coverage):
- `src/lib/business/splitEngine.test.ts`

✅ **UPI Generator** (21 tests):
- `src/lib/business/__tests__/upiGenerator.test.ts`

✅ **QR Code Generator** (32 tests):
- `src/lib/business/__tests__/qrCodeGenerator.test.ts`

✅ **Encryption** (9 tests):
- `src/lib/data/__tests__/encryption.test.ts`

✅ **Bill Repository** (14 tests):
- `src/lib/data/__tests__/billRepository.test.ts`

**Total**: 6 test suites, 103+ passing tests

---

## 2. E2E Testing (Detox)

### Configuration

**File**: `.detoxrc.js`

**Configurations**:
- iOS Simulator (Debug/Release)
- Android Emulator (Debug/Release)
- Android Physical Device (Debug/Release)

**Devices**:
- iOS: iPhone 15 simulator
- Android: Pixel 5 API 31 emulator
- Android: Physical device via ADB

### Setup

**Install Detox** (when ready to use):
```bash
npm install --save-dev detox@latest
```

**Build for Testing**:
```bash
# Android
npm run e2e:build:android

# iOS
npm run e2e:build:ios
```

**Run E2E Tests**:
```bash
# Android
npm run e2e:test:android

# iOS
npm run e2e:test:ios
```

### First E2E Test

**File**: `e2e/firstTest.test.js`

**Tests**:
1. App launches successfully
2. UPI Validation screen visible
3. Run UPI Validation button present
4. Device information displayed

**Expand Tests** (Future):
- Bill creation flow
- UPI link generation
- Payment status tracking
- Share functionality

---

## 3. CI/CD Pipeline (GitHub Actions)

### Configuration

**File**: `.github/workflows/ci.yml`

**Jobs**:

#### 1. Lint and TypeCheck
- ESLint validation
- TypeScript compilation check
- Runs on: Ubuntu latest
- Node.js: 20

#### 2. Unit Tests
- Jest with coverage
- Upload to Codecov
- Runs on: Ubuntu latest
- Node.js: 20

#### 3. Build Android
- Gradle build
- Generate debug APK
- Upload artifact
- Runs on: Ubuntu latest
- Java: 17

#### 4. Build iOS
- Xcode build
- CocoaPods installation
- Runs on: macOS latest
- iOS SDK: latest

#### 5. Security Scan
- npm audit
- Dependency vulnerability check
- Runs on: Ubuntu latest

### Triggers

**Push**:
- main branch
- develop branch

**Pull Request**:
- To main branch
- To develop branch

### Artifacts

**Android APK**:
- Name: `app-debug`
- Path: `android/app/build/outputs/apk/debug/app-debug.apk`
- Retention: 90 days

### Status Badges

Add to README.md:
```markdown
![CI](https://github.com/[username]/vasooly/workflows/CI/badge.svg)
[![codecov](https://codecov.io/gh/[username]/vasooly/branch/main/graph/badge.svg)](https://codecov.io/gh/[username]/vasooly)
```

---

## 4. Test Organization

### Directory Structure

```
vasooly/
├── src/
│   ├── __tests__/              # General tests
│   │   └── example.test.ts
│   └── lib/
│       ├── business/
│       │   ├── splitEngine.test.ts        # Co-located with source
│       │   └── __tests__/                 # Multiple tests
│       │       ├── upiGenerator.test.ts
│       │       └── qrCodeGenerator.test.ts
│       └── data/
│           └── __tests__/
│               ├── encryption.test.ts
│               └── billRepository.test.ts
├── e2e/
│   ├── jest.config.js          # Detox Jest config
│   └── firstTest.test.js       # E2E smoke test
├── coverage/                    # Generated by Jest
│   ├── lcov-report/            # HTML coverage
│   └── lcov.info               # LCOV format
├── jest.config.js              # Unit test config
├── jest.setup.js               # Test environment setup
└── .detoxrc.js                 # Detox configuration
```

### Naming Conventions

**Unit Tests**:
- `*.test.ts` or `*.test.tsx`
- `__tests__/*.test.ts`

**E2E Tests**:
- `e2e/*.test.js`

**Test Suites**:
- `describe('ComponentName', () => {...})`

**Test Cases**:
- `it('should do something', async () => {...})`

---

## 5. Development Workflow

### Pre-Commit Checklist

```bash
# Validate everything
npm run validate

# This runs:
# 1. TypeScript check
# 2. ESLint
# 3. Jest with coverage
```

### Adding New Tests

#### Unit Test Example:
```typescript
// src/lib/business/newFeature.test.ts
import { newFeature } from './newFeature';

describe('newFeature', () => {
  it('should handle normal case', () => {
    const result = newFeature('input');
    expect(result).toBe('expected');
  });

  it('should handle edge case', () => {
    const result = newFeature('');
    expect(result).toBe('');
  });
});
```

#### E2E Test Example:
```javascript
// e2e/billCreation.test.js
describe('Bill Creation Flow', () => {
  beforeAll(async () => {
    await device.launchApp();
  });

  it('should create a bill', async () => {
    await element(by.id('create-bill-button')).tap();
    await element(by.id('amount-input')).typeText('100');
    await element(by.id('save-button')).tap();
    await expect(element(by.text('Bill created'))).toBeVisible();
  });
});
```

---

## 6. Testing Best Practices

### Unit Tests

**DO**:
- Test business logic thoroughly
- Use meaningful test names
- Keep tests isolated and independent
- Mock external dependencies
- Test edge cases and error handling

**DON'T**:
- Test implementation details
- Create test dependencies
- Use real databases or network calls
- Duplicate tests
- Skip failing tests

### E2E Tests

**DO**:
- Test critical user flows
- Use stable selectors (testID)
- Keep tests independent
- Clean up state after tests
- Test on multiple devices/platforms

**DON'T**:
- Test every edge case (unit tests for that)
- Create long test scenarios
- Hard-code delays (use waitFor)
- Ignore flaky tests
- Test UI implementation details

### Coverage Goals

**Minimum** (Enforced by Jest):
- 70% coverage across all metrics

**Target** (For Production):
- 90%+ for business logic
- 100% for critical paths (split engine, encryption)
- 80%+ for data layer
- 70%+ for UI components

---

## 7. Continuous Integration

### Branch Protection

**Recommended Settings**:
- Require status checks to pass
- Require branches to be up to date
- Include administrators
- Require linear history

**Status Checks**:
- ✅ Lint and TypeCheck
- ✅ Unit Tests
- ✅ Build Android
- ✅ Build iOS
- ✅ Security Scan

### Deployment Pipeline (Future)

**Stages**:
1. **CI** (Current): Lint, test, build
2. **TestFlight/Beta**: Deploy to beta testers
3. **Production**: Deploy to app stores

**Triggers**:
- CI: Every push/PR
- Beta: Tag with `beta-*`
- Production: Tag with `v*.*.*`

---

## 8. Performance Testing (Future)

### Tools to Consider

**React Native Performance**:
- Flipper Performance Monitor
- React DevTools Profiler
- Xcode Instruments
- Android Studio Profiler

**Benchmarking**:
- Measure frame rates (target: 60fps)
- Monitor memory usage
- Track app startup time
- Profile animation performance

---

## 9. Troubleshooting

### Common Issues

**Jest fails with module errors**:
```bash
# Clear cache
npm test -- --clearCache
```

**Coverage not generated**:
```bash
# Check jest.config.js collectCoverageFrom
npm run test:coverage -- --verbose
```

**Detox build fails**:
```bash
# Clean builds
cd android && ./gradlew clean && cd ..
cd ios && pod install && cd ..
```

**CI pipeline fails**:
```bash
# Run locally
npm run validate
npm run test:ci
```

---

## 10. Next Steps

### Immediate (Phase 0 Complete)
- ✅ Unit tests operational
- ✅ E2E infrastructure ready
- ✅ CI/CD pipeline configured
- ✅ Coverage reporting enabled

### Phase 1 (Weeks 3-6)
- [ ] Expand unit test coverage to 90%
- [ ] Add E2E tests for bill creation flow
- [ ] Implement integration tests for native modules
- [ ] Set up visual regression testing

### Phase 3 (Weeks 11-13)
- [ ] Comprehensive E2E test suite
- [ ] Performance benchmark tests
- [ ] Load testing for 100+ bills
- [ ] Accessibility testing automation

---

## Summary

**Infrastructure Complete**:
- ✅ Jest unit testing with 103+ tests
- ✅ Detox E2E testing configured
- ✅ GitHub Actions CI/CD pipeline
- ✅ Code coverage reporting (text, HTML, LCOV)
- ✅ Quality validation command
- ✅ Branch protection ready

**Commands Available**:
```bash
npm test              # Run unit tests
npm run test:coverage # Generate coverage
npm run validate      # Full quality check
npm run e2e:test:android  # E2E tests (after Detox install)
```

**Next**: Physical device testing for UPI and Performance POCs

---

**Last Updated**: 2025-10-17
**Phase 0**: Complete ✅
